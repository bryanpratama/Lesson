<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jigsaw Puzzle Game</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      h1 {
        margin-bottom: 5px;
      }

      body.dark-mode {
        background-color: #121212;
        color: #f0f0f0;
      }

      .button-base {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
      }

      .button-base:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .dark-mode .button-base {
        background: #222;
        color: #f0f0f0;
        border: none;
      }
      .dark-mode .button-base:hover {
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .btn {
        background: #f4f4f4;
        color: black;
        border: none;
        margin: 5px;
      }

      .custom-checkbox-button {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        background: #f4f4f4;
        color: #000;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        user-select: none;
      }

      .custom-checkbox-button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .custom-checkbox-button input[type="checkbox"] {
        display: none;
      }

      .dark-mode .custom-checkbox-button {
        background: #222;
        color: #fff;
        border: none;
      }

      .dark-mode .custom-checkbox-button:hover {
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .custom-checkbox-button.active {
        background-color: #64ec64;
        border-color: #333;
      }
      .dark-mode .custom-checkbox-button.active {
        background-color: #079c07;
      }

      .custom-select {
        border: 1px solid #ccc;
        background-color: #f4f4f4;
      }

      .dark-mode .btn:hover {
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .btn-danger {
        background-color: #cc0000;
        color: white;
      }

      .btn-danger:hover {
        background-color: #a00000;
      }

      .dark-mode .btn-danger {
        background-color: #880000;
        color: #fff;
      }

      .dark-mode .puzzle-piece {
        border-color: #444;
      }

      .dark-mode .modal-content {
        background-color: #2c2c2c;
        color: #ffffff;
      }

      .highlight-correct {
        border: 2px solid limegreen !important;
        box-shadow: 0 0 5px limegreen;
      }

      #progressBarContainer {
        width: 300px;
        height: 20px;
        background-color: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px auto;
      }

      #progressBarFill {
        height: 100%;
        width: 0%;
        background-color: red;
        transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
      }

      #puzzle-container {
        width: 300px;
        height: 300px;
        display: flex;
        flex-wrap: wrap;
        border: 2px solid #ccc;
        margin: 20px auto;
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
      }

      .dark-mode #puzzle-container {
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .puzzle-piece {
        width: 100px;
        height: 100px;
        background-size: cover;
        background-position: center;
        box-sizing: border-box;
        border: 1px solid #ccc;
        cursor: grab;
      }

      .controls {
        margin-bottom: 20px;
      }

      .dark-mode select {
        background-color: #222;
        color: #fff;
        border: 1px solid #555;
      }

      .dark-mode select option {
        background-color: #111;
        color: #fff;
      }

      input[type="file"] {
        display: none;
      }

      .puzzle-piece.selected {
        outline: 2px solid yellow;
      }

      #timer {
        margin: 10px 0;
        font-size: 18px;
        font-weight: bold;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
        max-height: 90vh;
        overflow-y: auto;
      }

      .completion-stats {
        font-size: 16px;
        line-height: 1.8;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        text-align: left;
      }

      .completion-stats .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .completion-stats .gold {
        color: gold;
        font-weight: bold;
      }
      .completion-stats .silver {
        color: silver;
        font-weight: bold;
      }
      .completion-stats .bronze {
        color: peru;
        font-weight: bold;
      }
      .completion-stats .fail {
        color: red;
        font-weight: bold;
      }

      .leaderboard {
        font-size: 16px;
        text-align: left;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .leaderboard .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .lifetime-stats {
        font-size: 16px;
        text-align: left;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .lifetime-stats .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .lifetime-stats .stat-row {
        display: grid;
        grid-template-columns: 150px 1fr;
      }

      .lifetime-stats .label {
        font-weight: 500;
      }

      .lifetime-stats .value {
        font-weight: bold;
      }

      .board-block {
        border-top: 1px solid #666;
        padding-top: 10px;
      }

      .diff-row {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-row .label {
        font-weight: 500;
        white-space: nowrap;
      }

      .stat-row .value {
        font-weight: bold;
      }

      .stat-row {
        display: grid;
        grid-template-columns: 130px 1fr;
        gap: 15px;
        align-items: center;
      }

      .stat-row .score {
        color: gold;
      }

      .stat-row .gold {
        color: gold;
      }

      .stat-row .silver {
        color: silver;
      }

      .stat-row .bronze {
        color: peru;
      }

      .stat-row .fail {
        color: red;
      }

      .reset-container {
        text-align: center;
        margin-top: 15px;
      }

      .highlight-preview {
        position: relative;
        z-index: 9999 !important;
        box-shadow: 0 0 15px 5px orange;
        border: 3px solid orange !important;
        animation: pulseHighlight 0.8s ease-in-out infinite alternate;
      }

      .hidden {
        display: none;
      }

      #pauseOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgb(0, 0, 0);
        z-index: 9999;
        color: white;
        font-size: 24px;
        /* display: flex; */
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      body.dark-mode #pauseOverlay {
        background-color: rgba(0, 0, 0);
        color: #fff;
      }

      body:not(.dark-mode) #pauseOverlay {
        background-color: #f0f0f0;
        color: #000;
      }

      .hint-highlight {
        outline: 3px solid orange !important;
        border: 2px solid orange !important;
        box-shadow: 0 0 8px orange;
      }

      #previewContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
      }

      #previewContainer p {
        margin-bottom: 5px;
        font-weight: bold;
      }

      #previewImage {
        width: 300px;
        height: 300px;
        object-fit: cover;
        object-position: center;
        border-radius: 8px;
      }

      .btn.active {
        background-color: #64ec64;
        border-color: #333;
        color: white;
      }

      .dark-mode .btn.active {
        background-color: #079c07;
        color: #fff;
        border-color: #666;
      }

      #darkModeControl {
        margin-bottom: 10px;
      }

      .controls {
        margin-bottom: 15px;
      }

      .horizontal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .horizontal-buttons .btn {
        flex: 1;
        min-width: 120px;
      }

      .custom-select.active {
        background-color: #64ec64;
        border-color: #333;
        color: rgb(0, 0, 0);
      }

      .dark-mode .custom-select.active {
        background-color: #079c07;
        border-color: #666;
        color: #fff;
      }

      .counter-display {
        display: inline-block;
        margin: 8px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        background-color: #227744;
      }

      body:not(.dark-mode) .counter-display {
        color: #000;
      }

      body.dark-mode .counter-display {
        color: #fff;
      }

      #completionResult {
        margin: 20px auto;
        max-width: 400px;
      }

      .zoom-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        position: relative;
        z-index: 10;
      }

      #zoomControls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        padding: 8px 15px;
        border-radius: 12px;
        z-index: 9999;
      }
      #zoomControls button,
      #zoomControls input {
        cursor: pointer;
      }

      #zoomSlider {
        width: 150px;
      }

      .puzzle-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      #puzzle-scaler {
        display: inline-block;
        transition: transform 0.2s ease;
        transform-origin: top center;
        position: relative;
        z-index: 1;
      }

      @media (max-width: 500px) {
        #puzzle-container {
          width: 95vw;
          max-width: 320px;
        }

        #progressBarContainer {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Jigsaw Puzzle Game</h1>

    <div class="controls" id="preGameControls">
      <button class="btn button-base" onclick="startGame()">Start New Game</button>
      <input type="file" id="imageUpload" accept="image/*" />
      <select id="defaultImageSelector" class="custom-select button-base"></select>
      <button class="btn button-base" id="toggleDarkMode">Dark Mode</button>
      <div id="previewContainer">
        <p>Preview Gambar:</p>
        <img id="previewImage" src="" alt="Preview" />
      </div>
      <select id="difficulty" class="custom-select button-base">
        <option value="3">Easy (3x3)</option>
        <option value="4">Medium (4x4)</option>
        <option value="5">Hard (5x5)</option>
        <option value="6">Extreme (6x6)</option>
        <option value="7">Insane (7x7)</option>
        <option value="8">Godlike (8x8)</option>
      </select>
      <label id="rotationModeButton" class="custom-checkbox-button button-base">
        <input type="checkbox" id="rotationMode" />
        Mode Rotasi
      </label>
      <select id="challengeModeSelect" class="custom-select button-base">
        <option value="0" selected>🎯 Mode Tantangan: Nonaktif</option>
        <option value="60">🎯 Mode Tantangan: 1 Menit</option>
        <option value="120">🎯 Mode Tantangan: 2 Menit</option>
        <option value="300">🎯 Mode Tantangan: 5 Menit</option>
      </select>
      <button class="btn button-base" onclick="showLeaderboard()">🏆 Leaderboard</button>
      <button class="btn button-base" onclick="showStats()">📊 Statistik</button>
    </div>

    <div class="controls" id="inGameControls" style="display: none">
      <div id="progress" style="margin-top: 10px; font-weight: bold">Progress: 0%</div>
      <div id="progressBarContainer"><div id="progressBarFill"></div></div>

      <div id="undoButtonHidden" style="display: none">
        <button class="btn button-base" onclick="showOriginal()" id="showOriginal">Show Original</button>
        <button class="btn button-base" id="toggleDarkModeInGame">Dark Mode</button>
        <button class="btn button-base" id="highlightButton">Highlight Posisi Benar</button>

        <div id="toggleRotateButton" style="display: none">
          <button class="btn button-base" id="rotateSelected">🔄 Rotate</button>
        </div>

        <button class="btn button-base" id="undoButton">Undo</button>

        <button class="btn button-base" onclick="previewLastSwap()">👀 Lihat Langkah Terakhir</button>
        <button class="btn button-base" id="hintButton">🔍 Hint</button>
        <button class="btn button-base" id="pauseButton">Pause</button>
      </div>

      <div id="timer">Time: 00:00</div>
      <div id="hintCountDisplay" class="counter-display">Hint used: 0</div>
      <div id="highlightCountDisplay" class="counter-display">Highlight used: 0</div>

      <div id="toggleEndButton" style="display: none">
        <button class="btn btn-danger button-base" id="endGameButton" onclick="endGame()">🛑 End Game</button>
      </div>
      <div id="toggleShowButton" style="display: none">
        <button class="btn active button-base" id="closeButton" onclick="closeGame()">Close Game</button>
      </div>
    </div>

    <div class="puzzle-wrapper">
      <div id="puzzle-scaler">
        <div id="puzzle-container"></div>
      </div>
    </div>

    <!-- zoom controls keluar dari scaler -->
    <div class="zoom-controls" id="zoomControls" style="display: none">
      <button id="zoomOut">-</button>
      <input type="range" id="zoomSlider" min="50" max="150" value="100" />
      <button id="zoomIn">+</button>
    </div>

    <div id="completionResult"></div>

    <div id="original-image" style="display: none">
      <img id="originalImagePreview" src="image/image1.jpg" alt="Original Image" width="300" />
    </div>
    <div id="customModal" class="modal hidden">
      <div class="modal-content">
        <p id="modalMessage">Puzzle Completed!</p>
        <div id="modalButtons"></div>
      </div>
    </div>

    <div id="pauseOverlay">
      <div>Game Paused<br />Klik Resume untuk melanjutkan</div>
      <button class="btn button-base" id="resumeButton">Resume</button>
    </div>

    <script>
      const puzzleContainer = document.getElementById("puzzle-container");
      const timerDisplay = document.getElementById("timer");
      const originalImage = document.getElementById("original-image");
      const LEADERBOARD_KEY = "jigsawLeaderboard";

      let currentImageUrl = "image/image1.jpg";
      let pieces = [];
      let timer;
      let highlightTimer;
      let seconds = 0;
      let gridSize = 3;
      let lastSwapped = null;
      let hintCount = 0;
      let stepCount = 0;
      let score = 0;
      let isChallengeMode = false;
      let challengeTimeLeft = 120;
      let challengeTimeInitial = 0;
      let challengeTimer = null;
      let lastSwap = null;
      let highlightCount = 0;
      let highlightUsed = 0;

      const STATS_KEY = "jigsawStats";

      function updatePreviewImage(url) {
        const preview = document.getElementById("previewImage");
        preview.src = url;
        preview.style.display = "block";
      }

      function createPieces() {
        pieces = [];
        puzzleContainer.innerHTML = "";
        const pieceSize = 300 / gridSize;

        const img = new Image();
        img.src = currentImageUrl;
        img.onload = () => {
          const cropSize = Math.min(img.width, img.height);
          const offsetX = (img.width - cropSize) / 2;
          const offsetY = (img.height - cropSize) / 2;

          const squareCanvas = document.createElement("canvas");
          squareCanvas.width = 300;
          squareCanvas.height = 300;
          const squareCtx = squareCanvas.getContext("2d");

          squareCtx.drawImage(img, offsetX, offsetY, cropSize, cropSize, 0, 0, 300, 300);

          for (let row = 0; row < gridSize; row++) {
            for (let col = 0; col < gridSize; col++) {
              const piece = document.createElement("div");
              piece.classList.add("puzzle-piece");
              piece.style.width = `${pieceSize}px`;
              piece.style.height = `${pieceSize}px`;

              piece.id = `piece-${row}-${col}`;

              const canvas = document.createElement("canvas");
              canvas.width = pieceSize;
              canvas.height = pieceSize;
              const ctx = canvas.getContext("2d");

              ctx.drawImage(
                squareCanvas,
                col * pieceSize,
                row * pieceSize,
                pieceSize,
                pieceSize,
                0,
                0,
                pieceSize,
                pieceSize
              );

              const imgPiece = new Image();
              imgPiece.src = canvas.toDataURL();
              imgPiece.draggable = false;
              imgPiece.style.width = "100%";
              imgPiece.style.height = "100%";
              piece.appendChild(imgPiece);

              piece.dataset.correctRow = row;
              piece.dataset.correctCol = col;

              addEventsToPiece(piece);

              pieces.push(piece);
              puzzleContainer.appendChild(piece);
            }
          }

          shufflePieces();
        };
      }

      function shufflePieces() {
        pieces.sort(() => Math.random() - 0.5);
        pieces.forEach((piece) => puzzleContainer.appendChild(piece));

        if (document.getElementById("rotationMode").checked) {
          pieces.forEach((piece) => {
            const randomRotation = [0, 90, 180, 270][Math.floor(Math.random() * 4)];
            piece.style.transform = `rotate(${randomRotation}deg)`;
            piece.setAttribute("data-rotation", randomRotation);
          });
        }
      }

      let draggedPiece = null;

      function dragStart(e) {
        e.dataTransfer.setData("text/plain", e.target.id);
      }

      function dragOver(e) {
        e.preventDefault();
      }

      function dropPiece(e) {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData("text/plain");
        const draggedEl = document.getElementById(draggedId);
        const targetEl = e.currentTarget;

        if (!draggedEl || !targetEl || draggedEl === targetEl) return;

        const draggedClone = draggedEl.cloneNode(true);
        const targetClone = targetEl.cloneNode(true);

        const children = Array.from(puzzleContainer.children);
        const index1 = children.indexOf(draggedEl);
        const index2 = children.indexOf(targetEl);

        targetEl.replaceWith(draggedClone);
        draggedEl.replaceWith(targetClone);

        addEventsToPiece(draggedClone);
        addEventsToPiece(targetClone);

        lastSwapped = [index1, index2];

        updateProgress();
      }

      function addEventsToPiece(piece) {
        piece.draggable = true;
        piece.addEventListener("dragstart", dragStart);
        piece.addEventListener("dragover", dragOver);
        piece.addEventListener("drop", dropPiece);
        addClickToPiece(piece);
      }

      function showCompletionModal(time) {
        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        const buttons = document.getElementById("modalButtons");

        toggleShowButton(true);

        let timeSpent = isChallengeMode ? challengeTimeInitial - challengeTimeLeft : seconds;

        score = Math.max(0, 1000 - (timeSpent * 2 + hintCount * 50 + stepCount * 10));

        let medal = "";
        let rankClass = "";

        if (score >= 800) {
          medal = "🥇 Gold Medal";
          rankClass = "gold";
        } else if (score >= 500) {
          medal = "🥈 Silver Medal";
          rankClass = "silver";
        } else if (score >= 200) {
          medal = "🥉 Bronze Medal";
          rankClass = "bronze";
        } else {
          medal = "🤡 No Medal";
          rankClass = "fail";
        }

        const difficulty = document.getElementById("difficulty").value;
        const isRotationEnabled = document.getElementById("rotationMode").checked;
        const challengeTime = document.getElementById("challengeModeSelect").value;
        const isNewHigh = saveScoreToLeaderboard(
          difficulty,
          isRotationEnabled,
          challengeTime,
          score,
          formatTime(timeSpent),
          stepCount,
          hintCount,
          highlightUsed
        );

        message.innerHTML = `
        <div class="completion-stats">
            <div class="title">🎉 Puzzle Completed!</div>
            ${isNewHigh ? `<div style="color: limegreen; font-weight: bold;">🔥 New High Score!</div>` : ""}
            <div class="stat-row"><span class="label">⏱ Time</span><span class="value">${formatTime(
              timeSpent
            )}</span></div>
            <div class="stat-row"><span class="label">🔁 Steps</span><span class="value">${stepCount}</span></div>
            <div class="stat-row"><span class="label">💡 Hints used</span><span class="value">${hintCount}</span></div>
            <div class="stat-row"><span class="label">✨ Highlights used</span><span class="value">${highlightUsed}</span></div>
            <div class="stat-row"><span class="label">🧮 Score</span><span class="value score">${score}</span></div>
            <div class="stat-row"><span class="label">🏅 Rank</span><span class="value ${rankClass}">${medal}</span></div>
        </div>
    `;

        buttons.innerHTML = `
        <div class="reset-container horizontal-buttons">
            <button class="btn button-base" onclick="closeModal()">OK</button>
        </div>
    `;

        modal.classList.remove("hidden");
      }

      function closeModal() {
        const modal = document.getElementById("customModal");
        modal.classList.add("hidden");
        document.getElementById("modalButtons").innerHTML = "";

        const showOriginalBtn = document.getElementById("showOriginal");
        showOriginalBtn.classList.remove("active");
        showOriginalBtn.disabled = false;

        if (document.getElementById("modalMessage").querySelector(".completion-stats")) {
          const modalContent = document.getElementById("modalMessage").innerHTML;
          document.getElementById("completionResult").innerHTML = modalContent;
        }
      }

      function checkCompletion() {
        const currentPieces = [...puzzleContainer.children];
        let allCorrect = true;

        currentPieces.forEach((piece, index) => {
          const correctRow = Math.floor(index / gridSize);
          const correctCol = index % gridSize;

          const expectedRow = parseInt(piece.dataset.correctRow, 10);
          const expectedCol = parseInt(piece.dataset.correctCol, 10);

          if (correctRow !== expectedRow || correctCol !== expectedCol) {
            allCorrect = false;
          }

          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
          if (currentRotation !== 0) {
            allCorrect = false;
          }
        });

        if (allCorrect) {
          if (isChallengeMode) clearInterval(challengeTimer);
          clearInterval(timer);
          updateLifetimeStats(score, seconds, hintCount);
          disablePuzzleInteraction();

          setTimeout(() => {
            showCompletionModal(formatTime(seconds));
          }, 100);
        }
      }

      function endGame() {
        if (!document.querySelector(".puzzle-piece")) return;

        clearInterval(timer);
        if (isChallengeMode) clearInterval(challengeTimer);

        disablePuzzleInteraction();

        originalImage.style.display = "none";
        const showOriginalBtn = document.getElementById("showOriginal");
        showOriginalBtn.classList.remove("active");
        showOriginalBtn.disabled = false;

        showEndModal();
        toggleControls(false);
        toggleShowButton(false);
      }

      function closeGame() {
        document.getElementById("previewImage").style.display = "block";

        originalImage.style.display = "none";
        const showOriginalBtn = document.getElementById("showOriginal");
        showOriginalBtn.classList.remove("active");
        showOriginalBtn.disabled = false;

        toggleControls(false);
      }

      function showEndModal() {
        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        const buttons = document.getElementById("modalButtons");

        message.innerHTML = `
        <div style="text-align:center">
            <h3>😓 Puzzle Tidak Diselesaikan</h3>
            <p>Kamu menyerah. Puzzle belum selesai.</p>
        </div>
    `;

        buttons.innerHTML = `
        <div class="reset-container horizontal-buttons">
            <button class="btn button-base" onclick="closeModal()">OK</button>
        </div>
    `;

        modal.classList.remove("hidden");
        document.getElementById("previewImage").style.display = "block";
      }

      function startGame() {
        document.getElementById("previewImage").style.display = "none";

        document.getElementById("completionResult").innerHTML = "";

        const selectedDifficulty = document.getElementById("difficulty").value;
        gridSize = parseInt(selectedDifficulty);
        createPieces();
        originalImage.style.display = "none";
        seconds = 0;
        timerDisplay.textContent = "Time: 00:00";
        clearInterval(timer);
        isPaused = false;
        document.getElementById("pauseButton").innerText = "Pause";
        document.getElementById("pauseOverlay").style.display = "none";

        timer = setInterval(() => {
          seconds++;
          timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
        }, 1000);

        const showOriginalBtn = document.querySelector('button[onclick="showOriginal()"]');
        if (showOriginalBtn) {
          showOriginalBtn.classList.remove("original-shown");
          showOriginalBtn.disabled = false;
          originalImage.style.display = "none";
        }

        clearInterval(timer);
        clearInterval(challengeTimer);
        seconds = 0;
        challengeTimeLeft = 0;
        challengeTimeInitial = 0;

        const challengeValue = parseInt(document.getElementById("challengeModeSelect").value);
        isChallengeMode = challengeValue > 0;

        if (isChallengeMode) {
          challengeTimeLeft = challengeValue;
          challengeTimeInitial = challengeValue;
          timerDisplay.textContent = `Time left: ${formatTime(challengeTimeLeft)}`;

          challengeTimer = setInterval(() => {
            challengeTimeLeft--;
            timerDisplay.textContent = `Time left: ${formatTime(challengeTimeLeft)}`;
            if (challengeTimeLeft <= 0) {
              clearInterval(challengeTimer);
              clearInterval(timer);
              disablePuzzleInteraction();
              alert("⏱️ Waktu habis! Kamu gagal menyelesaikan puzzle.");
            }
          }, 1000);
        } else {
          timerDisplay.textContent = "Time: 00:00";
          timer = setInterval(() => {
            seconds++;
            timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
          }, 1000);
        }

        hintCount = 0;
        stepCount = 0;
        score = 0;
        highlightCount = 0;
        highlightUsed = 0;

        updateHighlightDisplay();
        updateHintDisplay();
        toggleShowButton(false);
        toggleControls(true);
        toggleShowRotate(document.getElementById("rotationMode").checked);

        updateProgress();
      }

      document.getElementById("imageUpload").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (event) {
            currentImageUrl = event.target.result;
            updatePreviewImage(currentImageUrl);
          };
          reader.readAsDataURL(file);
        }
      });

      function showOriginal() {
        const img = document.getElementById("originalImagePreview");
        img.src = currentImageUrl;
        originalImage.style.display = "block";

        const button = document.getElementById("showOriginal");
        button.classList.add("active");
        button.disabled = true;
      }

      function formatTime(secs) {
        const min = Math.floor(secs / 60)
          .toString()
          .padStart(2, "0");
        const sec = (secs % 60).toString().padStart(2, "0");
        return `${min}:${sec}`;
      }

      const toggleButton = document.getElementById("toggleDarkMode");
      document.getElementById("toggleDarkModeInGame").addEventListener("click", toggleTheme);

      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      toggleButton.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");

        if (document.body.classList.contains("dark-mode")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
      });

      window.addEventListener("DOMContentLoaded", () => {
        document.getElementById("puzzle-container").style.display = "none";
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark-mode");
        }

        updatePreviewImage(currentImageUrl);
      });

      document.getElementById("highlightButton").addEventListener("click", highlightCorrectPieces);

      function highlightCorrectPieces() {
        highlightUsed++;
        highlightCount++;
        updateHighlightDisplay();
        const pieces = puzzleContainer.children;

        for (let i = 0; i < pieces.length; i++) {
          pieces[i].classList.remove("highlight-correct");
        }

        clearTimeout(highlightTimer);

        for (let i = 0; i < pieces.length; i++) {
          const piece = pieces[i];
          const correctRow = Math.floor(i / gridSize);
          const correctCol = i % gridSize;
          const expectedRow = parseInt(piece.dataset.correctRow, 10);
          const expectedCol = parseInt(piece.dataset.correctCol, 10);
          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
          const isCorrectRotation = currentRotation === 0;
          const isCorrectPosition = correctRow === expectedRow && correctCol === expectedCol;

          if (isCorrectPosition && isCorrectRotation) {
            piece.classList.add("highlight-correct");
          }
        }

        highlightTimer = setTimeout(() => {
          for (let i = 0; i < pieces.length; i++) {
            pieces[i].classList.remove("highlight-correct");
          }
        }, 5000);
      }

      function updateHighlightDisplay() {
        document.getElementById("highlightCountDisplay").textContent = `Highlight used: ${highlightCount}`;
      }

      function getProgressColor(percentage) {
        if (percentage < 33) return "red";
        if (percentage < 66) return "orange";
        return "limegreen";
      }

      function updateProgress() {
        const pieces = puzzleContainer.children;
        let correctCount = 0;

        for (let i = 0; i < pieces.length; i++) {
          const piece = pieces[i];
          const correctRow = Math.floor(i / gridSize);
          const correctCol = i % gridSize;

          const expectedRow = parseInt(piece.dataset.correctRow, 10);
          const expectedCol = parseInt(piece.dataset.correctCol, 10);

          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
          const isCorrectRotation = currentRotation === 0;

          if (correctRow === expectedRow && correctCol === expectedCol && isCorrectRotation) {
            correctCount++;
          }
        }

        const total = gridSize * gridSize;
        const percentage = Math.round((correctCount / total) * 100);

        document.getElementById(
          "progress"
        ).textContent = `Progress: ${correctCount} / ${total} pieces in correct position (${percentage}%)`;

        const progressBarFill = document.getElementById("progressBarFill");
        progressBarFill.style.width = `${percentage}%`;
        progressBarFill.style.backgroundColor = getProgressColor(percentage);

        if (percentage === 100) {
          checkCompletion();
        }
      }

      let isPaused = false;

      document.getElementById("pauseButton").addEventListener("click", () => {
        clearInterval(timer);
        document.getElementById("pauseOverlay").style.display = "flex";
        isPaused = true;
      });

      document.getElementById("resumeButton").addEventListener("click", () => {
        timer = setInterval(() => {
          seconds++;
          timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
        }, 1000);
        document.getElementById("pauseOverlay").style.display = "none";
        isPaused = false;
      });

      const defaultImages = [
        { name: "Gambar default...", url: "image/image1.jpg" },
        { name: "Puncak-gunung", url: "image/Puncak-gunung.jpg" },
        { name: "Meja kerja", url: "image/Meja-kerja.jpg" },
        { name: "Pegunungan bersalju", url: "image/Pegunungan-bersalju.jpg" },
        { name: "Gedung apartemen", url: "image/Gedung-apartemen.jpg" },
        { name: "Kota metropolitan", url: "image/Kota-metropolitan.jpg" },
      ];

      const defaultImageSelector = document.getElementById("defaultImageSelector");

      defaultImages.forEach((img) => {
        const option = document.createElement("option");
        option.value = img.url;
        option.textContent = img.name;
        defaultImageSelector.appendChild(option);
      });

      const uploadOption = document.createElement("option");
      uploadOption.value = "__upload__";
      uploadOption.textContent = "📁 Upload Gambar...";
      defaultImageSelector.appendChild(uploadOption);

      defaultImageSelector.addEventListener("change", (e) => {
        const imageUrl = e.target.value;

        if (imageUrl === "__upload__") {
          document.getElementById("imageUpload").click();
          e.target.value = "";
        } else if (imageUrl) {
          currentImageUrl = imageUrl;
          updatePreviewImage(imageUrl);
        }
      });

      document.getElementById("undoButton").addEventListener("click", () => {
        if (!lastSwapped) return;

        const [index1, index2] = lastSwapped;
        const children = Array.from(puzzleContainer.children);
        const piece1 = children[index1];
        const piece2 = children[index2];

        const clone1 = piece1.cloneNode(true);
        const clone2 = piece2.cloneNode(true);

        puzzleContainer.replaceChild(clone1, piece2);
        puzzleContainer.replaceChild(clone2, piece1);

        [clone1, clone2].forEach((clone) => {
          clone.addEventListener("dragstart", dragStart);
          clone.addEventListener("dragover", dragOver);
          clone.addEventListener("drop", dropPiece);
          addClickToPiece(clone);
        });

        document.querySelectorAll(".puzzle-piece").forEach(addClickToPiece);
        lastSwapped = null;
        updateProgress();
        highlightCorrectPieces();
        document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("hint-highlight"));
      });

      function rotatePiece(piece) {
        const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
        const newRotation = (currentRotation + 90) % 360;
        piece.style.transform = `rotate(${newRotation}deg)`;
        piece.setAttribute("data-rotation", newRotation);

        checkCompletion();
        updateProgress();
      }

      document.addEventListener("contextmenu", (e) => {
        if (e.target.classList.contains("puzzle-piece") && document.getElementById("rotationMode").checked) {
          e.preventDefault();
          rotatePiece(e.target);
        }
      });

      document.getElementById("rotateSelected").addEventListener("click", () => {
        if (!document.getElementById("rotationMode").checked) return;

        const selected = document.querySelector(".puzzle-piece.selected");
        if (!selected) return;

        rotatePiece(selected);
      });

      function addClickToPiece(piece) {
        piece.addEventListener("click", () => {
          if (!document.getElementById("rotationMode").checked) return;

          document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("selected"));
          piece.classList.add("selected");
        });
      }

      const rotationCheckbox = document.getElementById("rotationMode");
      const rotationLabel = document.getElementById("rotationModeButton");

      rotationCheckbox.addEventListener("change", () => {
        rotationLabel.classList.toggle("active", rotationCheckbox.checked);
        toggleShowRotate(rotationCheckbox.checked);
      });

      const challengeModeSelect = document.getElementById("challengeModeSelect");

      challengeModeSelect.addEventListener("change", () => {
        if (challengeModeSelect.value !== "0") {
          challengeModeSelect.classList.add("active");
        } else {
          challengeModeSelect.classList.remove("active");
        }
      });

      document.getElementById("hintButton").addEventListener("click", showHint);

      function showHint() {
        const children = Array.from(puzzleContainer.children);
        const size = gridSize;

        let wrongIndex = -1;
        for (let i = 0; i < children.length; i++) {
          const piece = children[i];
          const expectedRow = Math.floor(i / size);
          const expectedCol = i % size;
          const row = parseInt(piece.dataset.correctRow, 10);
          const col = parseInt(piece.dataset.correctCol, 10);
          const rotation = parseInt(piece.getAttribute("data-rotation") || "0", 10);
          const rotationWrong = document.getElementById("rotationMode").checked && rotation !== 0;

          if (row !== expectedRow || col !== expectedCol || rotationWrong) {
            wrongIndex = i;
            break;
          }
        }

        if (wrongIndex === -1) return;

        const atTarget = children[wrongIndex];
        const expectedRow = Math.floor(wrongIndex / size);
        const expectedCol = wrongIndex % size;
        const row = parseInt(atTarget.dataset.correctRow, 10);
        const col = parseInt(atTarget.dataset.correctCol, 10);
        const rotation = parseInt(atTarget.getAttribute("data-rotation") || "0", 10);
        const rotationMode = document.getElementById("rotationMode").checked;

        if (row === expectedRow && col === expectedCol && rotationMode && rotation !== 0) {
          const fixed = atTarget.cloneNode(true);
          fixed.style.transform = "rotate(0deg)";
          fixed.setAttribute("data-rotation", "0");
          puzzleContainer.replaceChild(fixed, atTarget);
          addEventsToPiece(fixed);

          fixed.classList.add("hint-highlight");
          setTimeout(() => fixed.classList.remove("hint-highlight"), 800);

          hintCount++;
          updateHintDisplay();
          updateProgress();
          checkCompletion();
          lastSwapped = null;
          return;
        }

        const correctIndex = children.findIndex(
          (p) =>
            parseInt(p.dataset.correctRow, 10) === expectedRow && parseInt(p.dataset.correctCol, 10) === expectedCol
        );
        if (correctIndex === -1) return;

        const pieceAtTarget = children[wrongIndex];
        const correctPiece = children[correctIndex];

        const cloneA = pieceAtTarget.cloneNode(true);
        const cloneB = correctPiece.cloneNode(true);

        if (rotationMode) {
          cloneB.style.transform = "rotate(0deg)";
          cloneB.setAttribute("data-rotation", "0");
        }

        puzzleContainer.replaceChild(cloneB, pieceAtTarget);
        puzzleContainer.replaceChild(cloneA, correctPiece);

        addEventsToPiece(cloneA);
        addEventsToPiece(cloneB);

        lastSwapped = [wrongIndex, correctIndex];

        const newChildren = Array.from(puzzleContainer.children);
        newChildren[wrongIndex].classList.add("hint-highlight");
        setTimeout(() => newChildren[wrongIndex]?.classList.remove("hint-highlight"), 800);

        hintCount++;
        updateHintDisplay();
        updateProgress();
        checkCompletion();
      }

      function updateHintDisplay() {
        document.getElementById("hintCountDisplay").textContent = `Hint used: ${hintCount}`;
      }

      function saveScoreToLeaderboard(difficulty, isRotationEnabled, challengeTime, score, time, steps, hints) {
        const data = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {};
        const key = `${difficulty}-${isRotationEnabled}-${challengeTime}`;
        const currentBest = data[key];

        if (!currentBest || score > currentBest.score) {
          data[key] = { score, time, steps, hints, isRotationEnabled, challengeTime, difficulty };
          localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(data));
          return true;
        }
        return false;
      }

      function showLeaderboard() {
        const data = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {};
        let html = `<div class="leaderboard"><div class="title">🏆 Best Scores:</div>`;

        const keys = Object.keys(data);
        if (keys.length === 0) {
          html += `<div style="text-align:center; color:gray; font-style:italic;">Belum ada skor</div>`;
        } else {
          for (const key of keys) {
            const entry = data[key];
            const rotationText = entry.isRotationEnabled ? "🔄 Aktif" : "❌ Nonaktif";
            const challengeText = entry.challengeTime > 0 ? `${entry.challengeTime / 60} Menit` : "❌ Nonaktif";
            html += `
        <div class="board-block">
          <div class="diff-row">🧩 ${entry.difficulty}x${entry.difficulty}</div>
          <div class="stat-row"><span class="label">Mode Rotasi</span><span class="value">${rotationText}</span></div>
          <div class="stat-row"><span class="label">Mode Tantangan</span><span class="value">${challengeText}</span></div>
          <div class="stat-row"><span class="label">Skor</span><span class="value">${entry.score}</span></div>
          <div class="stat-row"><span class="label">Waktu</span><span class="value">${entry.time}</span></div>
          <div class="stat-row"><span class="label">Langkah</span><span class="value">${entry.steps}</span></div>
          <div class="stat-row"><span class="label">Hint</span><span class="value">${entry.hints}</span></div>
        </div>
      `;
          }
        }

        html += `
          <div class="reset-container horizontal-buttons">
            <button onclick="resetLeaderboard()" class="btn btn-danger button-base">🗑️ Reset Leaderboard</button>
            <button class="btn close-modal-button button-base" onclick="closeModal()">OK</button>
          </div>
        </div>`;

        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        message.innerHTML = html;
        modal.classList.remove("hidden");
      }

      function previewLastSwap() {
        document.querySelectorAll(".highlight-preview").forEach((p) => {
          p.classList.remove("highlight-preview");
        });

        if (!lastSwapped) return;

        const children = Array.from(puzzleContainer.children);
        const [index1, index2] = lastSwapped;
        const piece1 = children[index1];
        const piece2 = children[index2];

        [piece1, piece2].forEach((piece) => {
          piece.classList.add("highlight-preview");
        });

        setTimeout(() => {
          [piece1, piece2].forEach((piece) => {
            piece.classList.remove("highlight-preview");
          });
        }, 3000);
      }

      function updateLifetimeStats(score, time, hints) {
        const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || {
          totalGames: 0,
          totalTime: 0,
          totalScore: 0,
          totalHints: 0,
        };

        stats.totalGames += 1;
        stats.totalTime += time;
        stats.totalScore += score;
        stats.totalHints += hints;

        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
      }

      function showStats() {
        const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || {
          totalGames: 0,
          totalTime: 0,
          totalScore: 0,
          totalHints: 0,
        };

        const avgScore = stats.totalGames > 0 ? Math.round(stats.totalScore / stats.totalGames) : 0;

        const html = `
    <div class="lifetime-stats">
      <div class="title">📊 Statistik Lifetime</div>
      <div class="stat-row"><span class="label">🧩 Total Puzzle</span><span class="value">${
        stats.totalGames
      }</span></div>
      <div class="stat-row"><span class="label">⏱️ Total Waktu</span><span class="value">${formatTime(
        stats.totalTime
      )}</span></div>
      <div class="stat-row"><span class="label">🎯 Rata-rata Skor</span><span class="value">${avgScore}</span></div>
      <div class="stat-row"><span class="label">💡 Total Hint</span><span class="value">${stats.totalHints}</span></div>
    
    <div class="reset-container horizontal-buttons">
  <button onclick="resetStats()" class="btn btn-danger button-base">🗑️ Reset Statistik</button>
  <button class="btn close-modal-button button-base" onclick="closeModal()">OK</button>
</div>
    
    </div>
  `;

        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        message.innerHTML = html;
        modal.classList.remove("hidden");
      }

      function resetStats() {
        if (confirm("Yakin ingin menghapus semua statistik lifetime?")) {
          localStorage.removeItem(STATS_KEY);
          alert("Statistik lifetime telah direset.");
          showStats();
        }
      }

      function resetLeaderboard() {
        if (confirm("Yakin ingin menghapus semua data leaderboard?")) {
          localStorage.removeItem(LEADERBOARD_KEY);
          alert("Leaderboard telah direset.");
          showLeaderboard();
        }
      }

      function disablePuzzleInteraction() {
        const pieces = document.querySelectorAll(".puzzle-piece");
        pieces.forEach((piece) => {
          piece.setAttribute("draggable", "false");
          piece.style.cursor = "default";
          piece.removeEventListener("click", rotatePiece);
          piece.removeEventListener("dragstart", dragStart);
          piece.removeEventListener("dragover", dragOver);
          piece.removeEventListener("drop", dropPiece);
        });
      }

      document.getElementById("imageUpload").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (event) {
            currentImageUrl = event.target.result;
            updatePreviewImage(currentImageUrl);

            const opt = document.createElement("option");
            opt.value = currentImageUrl;
            opt.textContent = "📂 " + file.name;
            defaultImageSelector.appendChild(opt);
            defaultImageSelector.value = currentImageUrl;
          };
          reader.readAsDataURL(file);
        }
      });

      let zoomLevel = 100;

      function applyZoom() {
        const scaler = document.getElementById("puzzle-scaler");
        const scale = zoomLevel / 100;
        scaler.style.transform = `scale(${scale})`;

        const puzzle = document.getElementById("puzzle-container");
        const maxWidth = window.innerWidth * 0.9;
        if (puzzle.offsetWidth * scale > maxWidth) {
          zoomLevel = (maxWidth / puzzle.offsetWidth) * 100;
          scaler.style.transform = `scale(${zoomLevel / 100})`;
          document.getElementById("zoomSlider").value = zoomLevel;
        }
      }

      document.getElementById("zoomOut").addEventListener("click", () => {
        zoomLevel = Math.max(50, zoomLevel - 10);
        document.getElementById("zoomSlider").value = zoomLevel;
        applyZoom();
      });

      document.getElementById("zoomIn").addEventListener("click", () => {
        zoomLevel = Math.min(150, zoomLevel + 10);
        document.getElementById("zoomSlider").value = zoomLevel;
        applyZoom();
      });

      document.getElementById("zoomSlider").addEventListener("input", (e) => {
        zoomLevel = parseInt(e.target.value);
        applyZoom();
      });

      window.addEventListener("resize", applyZoom);

      document.getElementById("zoomOut").addEventListener("click", () => {
        zoomLevel = Math.max(50, zoomLevel - 10);
        document.getElementById("zoomSlider").value = zoomLevel;
        applyZoom();
      });

      document.getElementById("zoomIn").addEventListener("click", () => {
        zoomLevel = Math.min(150, zoomLevel + 10);
        document.getElementById("zoomSlider").value = zoomLevel;
        applyZoom();
      });

      document.getElementById("zoomSlider").addEventListener("input", (e) => {
        zoomLevel = parseInt(e.target.value);
        applyZoom();
      });

      window.addEventListener("resize", applyZoom);

      function toggleControls(isPlaying) {
        document.getElementById("preGameControls").style.display = isPlaying ? "none" : "block";
        document.getElementById("inGameControls").style.display = isPlaying ? "block" : "none";
        document.getElementById("puzzle-container").style.display = isPlaying ? "flex" : "none";
        document.getElementById("zoomControls").style.display = isPlaying ? "flex" : "none";
      }

      function toggleShowButton(isPlaying) {
        document.getElementById("toggleShowButton").style.display = isPlaying ? "block" : "none";
        document.getElementById("toggleEndButton").style.display = isPlaying ? "none" : "block";
        document.getElementById("undoButtonHidden").style.display = isPlaying ? "none" : "block";
      }

      function toggleShowRotate(isRotationMode) {
        document.getElementById("toggleRotateButton").style.display = isRotationMode ? "block" : "none";
      }

      updateProgress();
      // startGame();
    </script>
  </body>
</html>
