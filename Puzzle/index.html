<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jigsaw Puzzle Game</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
      }
      h1 {
        margin-bottom: 5px;
      }

      body.dark-mode {
        background-color: #121212;
        color: #f0f0f0;
      }

      .btn {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        background: #f4f4f4;
        color: black;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        margin: 5px;
      }

      .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .dark-mode .btn {
        background: #222;
        color: #f0f0f0;
        border: 1px solid #666;
      }

      .dark-mode .btn:hover {
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .btn-danger {
        background-color: #cc0000;
        color: white;
      }

      .btn-danger:hover {
        background-color: #a00000;
      }

      .dark-mode .btn-danger {
        background-color: #880000;
        color: #fff;
      }

      .dark-mode .puzzle-piece {
        border-color: #444;
      }

      .dark-mode .swal2-popup {
        background: #2c2c2c !important;
        color: #ffffff !important;
      }

      .dark-mode .swal2-title {
        color: #ffffff !important;
      }

      .dark-mode .swal2-content {
        color: #dddddd !important;
      }

      .dark-mode .modal-content {
        background-color: #2c2c2c;
        color: #ffffff;
      }

      .highlight-correct {
        border: 2px solid limegreen !important;
        box-shadow: 0 0 5px limegreen;
      }

      #progressBarContainer {
        width: 300px;
        height: 20px;
        background-color: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px auto;
      }

      #progressBarFill {
        height: 100%;
        width: 0%;
        background-color: red;
        transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
      }

      #puzzle-container {
        width: 90vw;
        max-width: 400px;
        height: 300px;
        margin: 0 auto;
        display: flex;
        flex-wrap: wrap;
        border: 2px solid #333;
        position: relative;
        aspect-ratio: 1 / 1;
      }

      .puzzle-piece {
        width: 100px;
        height: 100px;
        background-image: url("image/image1.jpg");
        background-size: 300px 300px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        cursor: grab;
      }

      .controls {
        margin-bottom: 20px;
      }

      .dark-mode select {
        background-color: #222;
        color: #fff;
        border: 1px solid #555;
      }

      .dark-mode select option {
        background-color: #111;
        color: #fff;
      }

      input[type="file"] {
        display: none;
      }

      .custom-file-upload {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        color: #000;
        background-color: #f4f4f4;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        margin: 5px;
        border: 2px;
        border-radius: 8px;
      }

      .custom-file-upload:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .dark-mode .custom-file-upload {
        background-color: #222;
        color: #f0f0f0;
        border: 1px solid #666;
      }

      .dark-mode .custom-file-upload:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .puzzle-piece.selected {
        outline: 2px solid yellow;
      }

      #timer {
        margin: 10px 0;
        font-size: 18px;
        font-weight: bold;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
        max-height: 90vh;
        overflow-y: auto;
      }

      .completion-stats {
        font-size: 16px;
        line-height: 1.8;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        text-align: left;
      }

      .completion-stats .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .completion-stats .score {
        font-weight: bold;
        color: gold;
      }

      .completion-stats .gold {
        color: gold;
        font-weight: bold;
      }
      .completion-stats .silver {
        color: silver;
        font-weight: bold;
      }
      .completion-stats .bronze {
        color: peru;
        font-weight: bold;
      }
      .completion-stats .fail {
        color: red;
        font-weight: bold;
      }

      .leaderboard {
        font-size: 16px;
        text-align: left;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .leaderboard .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .lifetime-stats {
        font-size: 16px;
        text-align: left;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .lifetime-stats .title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }

      .lifetime-stats .stat-row {
        display: grid;
        grid-template-columns: 150px 1fr;
      }

      .lifetime-stats .label {
        font-weight: 500;
      }

      .lifetime-stats .value {
        font-weight: bold;
      }

      .board-block {
        border-top: 1px solid #666;
        padding-top: 10px;
      }

      .diff-row {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-row .label {
        font-weight: 500;
      }

      .stat-row .value {
        font-weight: bold;
      }

      .stat-row {
        display: grid;
        grid-template-columns: 130px 1fr;
        gap: 5px;
        align-items: center;
      }

      .stat-row .score {
        color: gold;
      }

      .stat-row .gold {
        color: gold;
      }

      .stat-row .silver {
        color: silver;
      }

      .stat-row .bronze {
        color: peru;
      }

      .stat-row .fail {
        color: red;
      }

      .reset-container {
        text-align: center;
        margin-top: 15px;
      }

      .highlight-preview {
        outline: 4px dashed orange;
        animation: pulseBorder 0.5s ease-in-out infinite alternate;
      }

      @keyframes pulseBorder {
        from {
          outline-offset: 0px;
        }
        to {
          outline-offset: 4px;
        }
      }

      .hidden {
        display: none;
      }
      #originalImage {
        display: none;
        margin: 10px auto;
      }
      #pauseOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgb(0, 0, 0);
        z-index: 9999;
        color: white;
        font-size: 24px;
        /* display: flex; */
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      body.dark-mode #pauseOverlay {
        background-color: rgba(0, 0, 0);
        color: #fff;
      }

      body:not(.dark-mode) #pauseOverlay {
        background-color: #f0f0f0;
        color: #000;
      }

      .custom-checkbox-button {
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #f4f4f4;
        color: #000;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        user-select: none;
      }

      .custom-checkbox-button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .custom-checkbox-button input[type="checkbox"] {
        display: none;
      }

      .custom-checkbox-button.active {
        background-color: #64ec64;
        border-color: #333;
      }

      .dark-mode .custom-checkbox-button {
        background: #222;
        color: #fff;
        border: 1px solid #666;
      }

      .dark-mode .custom-checkbox-button:hover {
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .dark-mode .custom-checkbox-button.active {
        background-color: #079c07;
      }

      .custom-select {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 500;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f4f4f4;
        color: #000;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        height: 41px;
      }

      .custom-select:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.8);
      }

      .dark-mode .custom-select {
        background-color: #222;
        color: #f0f0f0;
        border: 1px solid #666;
      }

      .dark-mode .custom-select option {
        background-color: #111;
        color: #fff;
      }

      .dark-mode .custom-select:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 3px 5px rgba(255, 255, 255, 0.8);
      }

      .hint-highlight {
        animation: pulse 1s ease-in-out infinite;
        outline: 3px dashed orange !important;
      }

      #previewContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
      }

      #previewContainer p {
        margin-bottom: 5px;
        font-weight: bold;
      }

      #previewImage {
        max-width: 200px;
        border: 2px solid #888;
        border-radius: 6px;
      }

      .btn.active {
        background-color: #64ec64;
        border-color: #333;
        color: white;
      }

      .dark-mode .btn.active {
        background-color: #079c07;
        color: #fff;
        border-color: #666;
      }

      #darkModeControl {
        margin-bottom: 10px;
      }

      .controls {
        margin-bottom: 15px;
      }

      .horizontal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .horizontal-buttons .btn {
        flex: 1;
        min-width: 120px;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      @media (max-width: 500px) {
        #puzzle-container {
          width: 95vw;
          max-width: 320px;
        }

        #progressBarContainer {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Jigsaw Puzzle Game</h1>

    <div class="controls" id="preGameControls">
      <button class="btn" onclick="startGame()">Start New Game</button>
      <label for="imageUpload" class="custom-file-upload">Upload Gambar</label>
      <input type="file" id="imageUpload" accept="image/*" />
      <select id="defaultImageSelector" class="custom-select">
        <option value="">Pilih gambar default...</option>
      </select>
      <button class="btn" id="toggleDarkMode">Dark Mode</button>
      <div id="previewContainer">
        <p>Preview Gambar:</p>
        <img id="previewImage" src="" alt="Preview" />
      </div>
      <select id="difficulty" class="custom-select">
        <option value="3">Easy (3x3)</option>
        <option value="4">Medium (4x4)</option>
        <option value="5">Hard (5x5)</option>
        <option value="6">Extreme (6x6)</option>
        <option value="7">Insane (7x7)</option>
        <option value="8">Godlike (8x8)</option>
      </select>
      <label id="rotationModeButton" class="custom-checkbox-button">
        <input type="checkbox" id="rotationMode" />
        Mode Rotasi
      </label>
      <select id="challengeModeSelect" class="custom-select">
        <option value="0" selected>üéØ Mode Tantangan: Nonaktif</option>
        <option value="60">üéØ Mode Tantangan: 1 Menit</option>
        <option value="120">üéØ Mode Tantangan: 2 Menit</option>
        <option value="300">üéØ Mode Tantangan: 5 Menit</option>
      </select>
      <button class="btn" onclick="showLeaderboard()">üèÜ Leaderboard</button>
      <button class="btn" onclick="showStats()">üìä Statistik</button>
    </div>

    <div class="controls" id="inGameControls" style="display: none">
      <div id="progress" style="margin-top: 10px; font-weight: bold">Progress: 0%</div>
      <div id="progressBarContainer"><div id="progressBarFill"></div></div>

      <div id="undoButtonHidden" style="display: none">
        <button class="btn" onclick="showOriginal()" id="showOriginal">Show Original</button>
        <button class="btn" id="toggleDarkModeInGame">Dark Mode</button>
        <button class="btn" id="highlightButton">Highlight Posisi Benar</button>

        <div id="toggleRotateButton" style="display: none">
          <button class="btn" id="rotateSelected">üîÑ Rotate</button>
        </div>

        <button class="btn" id="undoButton">Undo</button>

        <button class="btn" onclick="previewLastSwap()">üëÄ Lihat Langkah Terakhir</button>
        <button class="btn" id="hintButton">üîç Hint</button>
        <button class="btn" id="pauseButton">Pause</button>
      </div>

      <div id="timer">Time: 00:00</div>
      <div id="hintCountDisplay">Hint used: 0</div>

      <div id="toggleEndButton" style="display: none">
        <button class="btn btn-danger" id="endGameButton" onclick="endGame()">üõë End Game</button>
      </div>
      <div id="toggleShowButton" style="display: none">
        <button class="btn active" id="closeButton" onclick="closeGame()">Close Game</button>
      </div>
    </div>

    <div id="puzzle-container"></div>

    <div id="original-image" style="display: none">
      <img id="originalImagePreview" src="image/image1.jpg" alt="Original Image" width="300" />
    </div>
    <div id="customModal" class="modal hidden">
      <div class="modal-content">
        <p id="modalMessage">Puzzle Completed!</p>
        <div id="modalButtons"></div>
      </div>
    </div>

    <div id="pauseOverlay">
      <div>Game Paused<br />Klik Resume untuk melanjutkan</div>
      <button class="btn" id="resumeButton">Resume</button>
    </div>

    <script>
      const puzzleContainer = document.getElementById("puzzle-container");
      const timerDisplay = document.getElementById("timer");
      const originalImage = document.getElementById("original-image");
      const LEADERBOARD_KEY = "jigsawLeaderboard";

      let currentImageUrl = "image/image1.jpg";
      let pieces = [];
      let timer;
      let seconds = 0;
      let gridSize = 3;
      let lastSwapped = null;
      let hintCount = 0;
      let stepCount = 0;
      let score = 0;
      let isChallengeMode = false;
      let challengeTimeLeft = 120;
      let challengeTimeInitial = 0;
      let challengeTimer = null;
      let lastSwap = null;
      const STATS_KEY = "jigsawStats";

      function updatePreviewImage(url) {
        const preview = document.getElementById("previewImage");
        preview.src = url;
        preview.style.display = "block";
      }

      function createPieces() {
        pieces = [];
        puzzleContainer.innerHTML = "";
        const pieceSize = 300 / gridSize;

        for (let row = 0; row < gridSize; row++) {
          for (let col = 0; col < gridSize; col++) {
            const piece = document.createElement("div");
            piece.classList.add("puzzle-piece");
            piece.style.width = piece.style.height = `${pieceSize}px`;
            piece.style.backgroundSize = `300px 300px`;
            piece.style.backgroundImage = `url("${currentImageUrl}")`;
            piece.style.backgroundPosition = `-${col * pieceSize}px -${row * pieceSize}px`;
            piece.setAttribute("data-position", `${row}-${col}`);
            piece.draggable = true;

            if (document.getElementById("rotationMode").checked) {
              const angle = [0, 90, 180, 270][Math.floor(Math.random() * 4)];
              piece.style.transform = `rotate(${angle}deg)`;
              piece.setAttribute("data-rotation", angle);
            } else {
              piece.setAttribute("data-rotation", 0);
            }

            piece.addEventListener("dragstart", dragStart);
            piece.addEventListener("dragover", dragOver);
            piece.addEventListener("drop", dropPiece);

            pieces.push(piece);
          }
        }

        shufflePieces();
        document.querySelectorAll(".puzzle-piece").forEach(addClickToPiece);
        puzzleContainer.style.width = puzzleContainer.style.height = `${300}px`;
        puzzleContainer.style.flexWrap = "wrap";
        updateProgress();
      }

      function shufflePieces() {
        pieces.sort(() => Math.random() - 0.5);
        pieces.forEach((piece) => puzzleContainer.appendChild(piece));
      }

      let draggedPiece = null;

      function dragStart(e) {
        draggedPiece = e.target;
      }

      function dragOver(e) {
        e.preventDefault();
      }

      function dropPiece(e) {
        if (draggedPiece === e.target) return;

        const from = draggedPiece;
        const to = e.target;

        const children = Array.from(puzzleContainer.children);
        const fromIndex = children.indexOf(from);
        const toIndex = children.indexOf(to);

        lastSwapped = [fromIndex, toIndex];
        const fromClone = from.cloneNode(true);
        const toClone = to.cloneNode(true);

        puzzleContainer.replaceChild(fromClone, to);
        puzzleContainer.replaceChild(toClone, from);

        [fromClone, toClone].forEach((clone) => {
          clone.addEventListener("dragstart", dragStart);
          clone.addEventListener("dragover", dragOver);
          clone.addEventListener("drop", dropPiece);
          addClickToPiece(clone);
        });

        lastSwap = [fromClone, toClone];

        setTimeout(checkCompletion, 50);
        stepCount++;

        updateProgress();
        document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("hint-highlight"));
      }

      function showCompletionModal(time) {
        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        const buttons = document.getElementById("modalButtons");

        toggleShowButton(true);

        let timeSpent = isChallengeMode ? challengeTimeInitial - challengeTimeLeft : seconds;

        score = Math.max(0, 1000 - (timeSpent * 2 + hintCount * 50 + stepCount * 10));

        let medal = "";
        let rankClass = "";

        if (score >= 800) {
          medal = "ü•á Gold Medal";
          rankClass = "gold";
        } else if (score >= 500) {
          medal = "ü•à Silver Medal";
          rankClass = "silver";
        } else if (score >= 200) {
          medal = "ü•â Bronze Medal";
          rankClass = "bronze";
        } else {
          medal = "ü§° No Medal";
          rankClass = "fail";
        }

        const difficulty = document.getElementById("difficulty").value;
        const isRotationEnabled = document.getElementById("rotationMode").checked;
        const challengeTime = document.getElementById("challengeModeSelect").value;
        const isNewHigh = saveScoreToLeaderboard(
          difficulty,
          isRotationEnabled,
          challengeTime,
          score,
          formatTime(timeSpent),
          stepCount,
          hintCount
        );

        message.innerHTML = `
        <div class="completion-stats">
            <div class="title">üéâ Puzzle Completed!</div>
            ${isNewHigh ? `<div style="color: limegreen; font-weight: bold;">üî• New High Score!</div>` : ""}
            <div class="stat-row"><span class="label">‚è± Time</span><span class="value">${formatTime(
              timeSpent
            )}</span></div>
            <div class="stat-row"><span class="label">üîÅ Steps</span><span class="value">${stepCount}</span></div>
            <div class="stat-row"><span class="label">üí° Hints used</span><span class="value">${hintCount}</span></div>
            <div class="stat-row"><span class="label">üßÆ Score</span><span class="value score">${score}</span></div>
            <div class="stat-row"><span class="label">üèÖ Rank</span><span class="value ${rankClass}">${medal}</span></div>
        </div>
    `;

        buttons.innerHTML = `
        <div class="reset-container horizontal-buttons">
            <button class="btn close-modal-button" onclick="closeModal()">OK</button>
        </div>
    `;

        modal.classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("customModal").classList.add("hidden");
        document.getElementById("modalButtons").innerHTML = "";

        const showOriginalBtn = document.getElementById("showOriginal");
        showOriginalBtn.classList.remove("active");
        showOriginalBtn.disabled = false;
      }

      function checkCompletion() {
        const currentPieces = [...puzzleContainer.children];
        const pieceSize = 300 / gridSize;

        const allCorrect = currentPieces.every((piece, index) => {
          const correctRow = Math.floor(index / gridSize);
          const correctCol = index % gridSize;

          const expectedX = -correctCol * pieceSize;
          const expectedY = -correctRow * pieceSize;

          const bgPos = window.getComputedStyle(piece).backgroundPosition.split(" ");
          const currentX = parseFloat(bgPos[0]);
          const currentY = parseFloat(bgPos[1]);
          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");

          const isCorrectPosition = Math.abs(currentX - expectedX) < 1 && Math.abs(currentY - expectedY) < 1;

          const isCorrectRotation = currentRotation === 0;

          return isCorrectPosition && isCorrectRotation;
        });

        if (allCorrect) {
          if (isChallengeMode) clearInterval(challengeTimer);

          clearInterval(timer);
          updateLifetimeStats(score, seconds, hintCount);
          disablePuzzleInteraction();

          setTimeout(() => {
            showCompletionModal(formatTime(seconds));
          }, 100);
        }
      }

      function endGame() {
        if (!document.querySelector(".puzzle-piece")) return;

        clearInterval(timer);
        if (isChallengeMode) clearInterval(challengeTimer);

        disablePuzzleInteraction();

        showEndModal();
        toggleControls(false);
        toggleShowButton(false);
      }

      function closeGame() {
        document.getElementById("previewImage").style.display = "block";

        toggleControls(false);
      }

      function showEndModal() {
        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        const buttons = document.getElementById("modalButtons");

        message.innerHTML = `
        <div style="text-align:center">
            <h3>üòì Puzzle Tidak Diselesaikan</h3>
            <p>Kamu menyerah. Puzzle belum selesai.</p>
        </div>
    `;

        buttons.innerHTML = `
        <div class="reset-container horizontal-buttons">
            <button class="btn close-modal-button" onclick="closeModal()">OK</button>
        </div>
    `;

        modal.classList.remove("hidden");
        document.getElementById("previewImage").style.display = "block";
      }

      function startGame() {
        document.getElementById("previewImage").style.display = "none";

        const selectedDifficulty = document.getElementById("difficulty").value;
        gridSize = parseInt(selectedDifficulty);
        createPieces();
        originalImage.style.display = "none";
        seconds = 0;
        timerDisplay.textContent = "Time: 00:00";
        clearInterval(timer);
        isPaused = false;
        document.getElementById("pauseButton").innerText = "Pause";
        document.getElementById("pauseOverlay").style.display = "none";

        timer = setInterval(() => {
          seconds++;
          timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
        }, 1000);

        const showOriginalBtn = document.querySelector('button[onclick="showOriginal()"]');
        if (showOriginalBtn) {
          showOriginalBtn.classList.remove("original-shown");
          showOriginalBtn.disabled = false;
          originalImage.style.display = "none";
        }

        clearInterval(timer);
        clearInterval(challengeTimer);
        seconds = 0;
        challengeTimeLeft = 0;
        challengeTimeInitial = 0;

        const challengeValue = parseInt(document.getElementById("challengeModeSelect").value);
        isChallengeMode = challengeValue > 0;

        if (isChallengeMode) {
          challengeTimeLeft = challengeValue;
          challengeTimeInitial = challengeValue;
          timerDisplay.textContent = `Time left: ${formatTime(challengeTimeLeft)}`;

          challengeTimer = setInterval(() => {
            challengeTimeLeft--;
            timerDisplay.textContent = `Time left: ${formatTime(challengeTimeLeft)}`;
            if (challengeTimeLeft <= 0) {
              clearInterval(challengeTimer);
              clearInterval(timer);
              disablePuzzleInteraction();
              alert("‚è±Ô∏è Waktu habis! Kamu gagal menyelesaikan puzzle.");
            }
          }, 1000);
        } else {
          timerDisplay.textContent = "Time: 00:00";
          timer = setInterval(() => {
            seconds++;
            timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
          }, 1000);
        }

        hintCount = 0;
        stepCount = 0;
        score = 0;

        updateHintDisplay();
        toggleShowButton(false);
        toggleControls(true);
        toggleShowRotate(document.getElementById("rotationMode").checked);
      }

      document.getElementById("imageUpload").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (event) {
            currentImageUrl = event.target.result;
            updatePreviewImage(currentImageUrl);
          };
          reader.readAsDataURL(file);
        }
      });

      function showOriginal() {
        const img = document.getElementById("originalImagePreview");
        img.src = currentImageUrl;
        originalImage.style.display = "block";

        const button = document.getElementById("showOriginal");
        button.classList.add("active");
        button.disabled = true;
      }

      function formatTime(secs) {
        const min = Math.floor(secs / 60)
          .toString()
          .padStart(2, "0");
        const sec = (secs % 60).toString().padStart(2, "0");
        return `${min}:${sec}`;
      }

      const toggleButton = document.getElementById("toggleDarkMode");
      document.getElementById("toggleDarkModeInGame").addEventListener("click", toggleTheme);

      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      toggleButton.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");

        if (document.body.classList.contains("dark-mode")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
      });

      window.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark-mode");
        }

        updatePreviewImage(currentImageUrl);
      });

      document.getElementById("highlightButton").addEventListener("click", highlightCorrectPieces);

      function highlightCorrectPieces() {
        const pieces = puzzleContainer.children;
        const pieceSize = 300 / gridSize;

        for (let i = 0; i < pieces.length; i++) {
          const piece = pieces[i];
          const correctRow = Math.floor(i / gridSize);
          const correctCol = i % gridSize;

          const expectedX = -correctCol * pieceSize;
          const expectedY = -correctRow * pieceSize;

          const bgPos = window.getComputedStyle(piece).backgroundPosition.split(" ");
          const currentX = parseFloat(bgPos[0]);
          const currentY = parseFloat(bgPos[1]);

          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
          const isCorrectRotation = currentRotation === 0;

          const isCorrectPosition = Math.abs(currentX - expectedX) < 1 && Math.abs(currentY - expectedY) < 1;

          if (isCorrectPosition && isCorrectRotation) {
            piece.classList.add("highlight-correct");
          } else {
            piece.classList.remove("highlight-correct");
          }
        }
      }

      function getProgressColor(percentage) {
        if (percentage < 33) return "red";
        if (percentage < 66) return "orange";
        return "limegreen";
      }

      function updateProgress() {
        document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("highlight-correct"));

        const pieces = puzzleContainer.children;
        const pieceSize = 300 / gridSize;
        let correctCount = 0;

        for (let i = 0; i < pieces.length; i++) {
          const piece = pieces[i];
          const correctRow = Math.floor(i / gridSize);
          const correctCol = i % gridSize;

          const expectedX = -correctCol * pieceSize;
          const expectedY = -correctRow * pieceSize;

          const bgPos = window.getComputedStyle(piece).backgroundPosition.split(" ");
          const currentX = parseFloat(bgPos[0]);
          const currentY = parseFloat(bgPos[1]);

          const isCorrectPosition = Math.abs(currentX - expectedX) < 1 && Math.abs(currentY - expectedY) < 1;

          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
          const isCorrectRotation = currentRotation === 0;

          if (isCorrectPosition && isCorrectRotation) {
            correctCount++;
          }
        }

        const total = gridSize * gridSize;
        const percentage = Math.round((correctCount / total) * 100);

        document.getElementById(
          "progress"
        ).textContent = `Progress: ${correctCount} / ${total} pieces in correct position (${percentage}%)`;

        document.getElementById("progressBarFill").style.width = `${percentage}%`;
        document.getElementById("progressBarFill").style.backgroundColor = getProgressColor(percentage);
      }

      let isPaused = false;

      document.getElementById("pauseButton").addEventListener("click", () => {
        clearInterval(timer);
        document.getElementById("pauseOverlay").style.display = "flex";
        isPaused = true;
      });

      document.getElementById("resumeButton").addEventListener("click", () => {
        timer = setInterval(() => {
          seconds++;
          timerDisplay.textContent = `Time: ${formatTime(seconds)}`;
        }, 1000);
        document.getElementById("pauseOverlay").style.display = "none";
        isPaused = false;
      });

      const defaultImages = [
        { name: "Puncak-gunung", url: "image/Puncak-gunung.jpg" },
        { name: "Meja kerja", url: "image/Meja-kerja.jpg" },
        { name: "Pegunungan bersalju", url: "image/Pegunungan-bersalju.jpg" },
        { name: "Gedung apartemen", url: "image/Gedung-apartemen.jpg" },
        { name: "Kota metropolitan", url: "image/Kota-metropolitan.jpg" },
      ];

      const defaultImageSelector = document.getElementById("defaultImageSelector");

      defaultImages.forEach((img) => {
        const option = document.createElement("option");
        option.value = img.url;
        option.textContent = img.name;
        defaultImageSelector.appendChild(option);
      });

      defaultImageSelector.addEventListener("change", (e) => {
        const imageUrl = e.target.value;
        if (imageUrl) {
          currentImageUrl = imageUrl;
          updatePreviewImage(imageUrl);
        }
      });

      document.getElementById("undoButton").addEventListener("click", () => {
        if (!lastSwapped) return;

        const [index1, index2] = lastSwapped;
        const children = Array.from(puzzleContainer.children);
        const piece1 = children[index1];
        const piece2 = children[index2];

        const clone1 = piece1.cloneNode(true);
        const clone2 = piece2.cloneNode(true);

        puzzleContainer.replaceChild(clone1, piece2);
        puzzleContainer.replaceChild(clone2, piece1);

        [clone1, clone2].forEach((clone) => {
          clone.addEventListener("dragstart", dragStart);
          clone.addEventListener("dragover", dragOver);
          clone.addEventListener("drop", dropPiece);
          addClickToPiece(clone);
        });

        document.querySelectorAll(".puzzle-piece").forEach(addClickToPiece);
        lastSwapped = null;
        updateProgress();
        highlightCorrectPieces();
        document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("hint-highlight"));
      });

      function rotatePiece(piece) {
        const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");
        const newRotation = (currentRotation + 90) % 360;
        piece.style.transform = `rotate(${newRotation}deg)`;
        piece.setAttribute("data-rotation", newRotation);

        checkCompletion();
        updateProgress();
      }

      document.addEventListener("contextmenu", (e) => {
        if (e.target.classList.contains("puzzle-piece") && document.getElementById("rotationMode").checked) {
          e.preventDefault();
          rotatePiece(e.target);
        }
      });

      document.getElementById("rotateSelected").addEventListener("click", () => {
        if (!document.getElementById("rotationMode").checked) return;

        const selected = document.querySelector(".puzzle-piece.selected");
        if (!selected) return;

        rotatePiece(selected);
      });

      function addClickToPiece(piece) {
        piece.addEventListener("click", () => {
          if (!document.getElementById("rotationMode").checked) return;

          document.querySelectorAll(".puzzle-piece").forEach((p) => p.classList.remove("selected"));
          piece.classList.add("selected");
        });
      }

      const rotationCheckbox = document.getElementById("rotationMode");
      const rotationLabel = document.getElementById("rotationModeButton");

      rotationCheckbox.addEventListener("change", () => {
        rotationLabel.classList.toggle("active", rotationCheckbox.checked);
        toggleShowRotate(rotationCheckbox.checked);
      });

      document.getElementById("hintButton").addEventListener("click", showHint);

      function showHint() {
        const pieces = Array.from(puzzleContainer.children);
        const pieceSize = 300 / gridSize;

        for (let i = 0; i < pieces.length; i++) {
          const piece = pieces[i];
          const correctRow = Math.floor(i / gridSize);
          const correctCol = i % gridSize;

          const expectedX = -correctCol * pieceSize;
          const expectedY = -correctRow * pieceSize;

          const bgPos = window.getComputedStyle(piece).backgroundPosition.split(" ");
          const currentX = parseFloat(bgPos[0]);
          const currentY = parseFloat(bgPos[1]);
          const currentRotation = parseInt(piece.getAttribute("data-rotation") || "0");

          const isCorrectPosition = Math.abs(currentX - expectedX) < 1 && Math.abs(currentY - expectedY) < 1;
          const isCorrectRotation = currentRotation === 0;

          if (!isCorrectPosition || !isCorrectRotation) {
            const correctPiece = pieces.find((p) => {
              const bg = window.getComputedStyle(p).backgroundPosition.split(" ");
              const bx = parseFloat(bg[0]);
              const by = parseFloat(bg[1]);
              return Math.abs(bx - expectedX) < 1 && Math.abs(by - expectedY) < 1;
            });

            if (correctPiece && correctPiece !== piece) {
              const tempPos = piece.style.backgroundPosition;
              piece.style.backgroundPosition = correctPiece.style.backgroundPosition;
              correctPiece.style.backgroundPosition = tempPos;

              const rotA = piece.getAttribute("data-rotation") || "0";
              const rotB = correctPiece.getAttribute("data-rotation") || "0";

              piece.setAttribute("data-rotation", rotB);
              correctPiece.setAttribute("data-rotation", rotA);

              piece.style.transform = `rotate(${rotB}deg)`;
              correctPiece.style.transform = `rotate(${rotA}deg)`;

              correctPiece.classList.add("hint-highlight");
              setTimeout(() => {
                correctPiece.classList.remove("hint-highlight");
              }, 1000);

              hintCount++;
              updateHintDisplay();

              updateProgress();
              checkCompletion();
              break;
            }
          }
        }
      }

      function updateHintDisplay() {
        document.getElementById("hintCountDisplay").textContent = `Hint used: ${hintCount}`;
      }

      function saveScoreToLeaderboard(difficulty, isRotationEnabled, challengeTime, score, time, steps, hints) {
        const data = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {};
        const key = `${difficulty}-${isRotationEnabled}-${challengeTime}`;
        const currentBest = data[key];

        if (!currentBest || score > currentBest.score) {
          data[key] = { score, time, steps, hints, isRotationEnabled, challengeTime, difficulty };
          localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(data));
          return true;
        }
        return false;
      }

      function showLeaderboard() {
        const data = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || {};
        let html = `<div class="leaderboard"><div class="title">üèÜ Best Scores:</div>`;

        for (const key in data) {
          const entry = data[key];
          const rotationText = entry.isRotationEnabled ? "üîÑ Aktif" : "‚ùå Nonaktif";
          const challengeText = entry.challengeTime > 0 ? `${entry.challengeTime / 60} Menit` : "‚ùå Nonaktif";
          html += `
            <div class="board-block">
              <div class="diff-row">üß© ${entry.difficulty}x${entry.difficulty}</div>
              <div class="stat-row"><span class="label">Mode Rotasi</span><span class="value">${rotationText}</span></div>
              <div class="stat-row"><span class="label">Mode Tantangan</span><span class="value">${challengeText}</span></div>
              <div class="stat-row"><span class="label">Skor</span><span class="value">${entry.score}</span></div>
              <div class="stat-row"><span class="label">Waktu</span><span class="value">${entry.time}</span></div>
              <div class="stat-row"><span class="label">Langkah</span><span class="value">${entry.steps}</span></div>
              <div class="stat-row"><span class="label">Hint</span><span class="value">${entry.hints}</span></div>
            </div>
          `;
        }

        html += `
          <div class="reset-container horizontal-buttons">
            <button onclick="resetLeaderboard()" class="btn btn-danger">üóëÔ∏è Reset Leaderboard</button>
            <button class="btn close-modal-button" onclick="closeModal()">OK</button>
          </div>
        </div>`;

        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        message.innerHTML = html;
        modal.classList.remove("hidden");
      }

      function previewLastSwap() {
        document.querySelectorAll(".highlight-preview").forEach((p) => {
          p.classList.remove("highlight-preview");
        });

        if (!lastSwap) return;

        lastSwap.forEach((piece) => {
          piece.classList.add("highlight-preview");
        });

        setTimeout(() => {
          lastSwap?.forEach((piece) => {
            piece.classList.remove("highlight-preview");
          });
        }, 3000);
      }

      function updateLifetimeStats(score, time, hints) {
        const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || {
          totalGames: 0,
          totalTime: 0,
          totalScore: 0,
          totalHints: 0,
        };

        stats.totalGames += 1;
        stats.totalTime += time;
        stats.totalScore += score;
        stats.totalHints += hints;

        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
      }

      function showStats() {
        const stats = JSON.parse(localStorage.getItem(STATS_KEY)) || {
          totalGames: 0,
          totalTime: 0,
          totalScore: 0,
          totalHints: 0,
        };

        const avgScore = stats.totalGames > 0 ? Math.round(stats.totalScore / stats.totalGames) : 0;

        const html = `
    <div class="lifetime-stats">
      <div class="title">üìä Statistik Lifetime</div>
      <div class="stat-row"><span class="label">üß© Total Puzzle</span><span class="value">${
        stats.totalGames
      }</span></div>
      <div class="stat-row"><span class="label">‚è±Ô∏è Total Waktu</span><span class="value">${formatTime(
        stats.totalTime
      )}</span></div>
      <div class="stat-row"><span class="label">üéØ Rata-rata Skor</span><span class="value">${avgScore}</span></div>
      <div class="stat-row"><span class="label">üí° Total Hint</span><span class="value">${stats.totalHints}</span></div>
    
    <div class="reset-container horizontal-buttons">
  <button onclick="resetStats()" class="btn btn-danger">üóëÔ∏è Reset Statistik</button>
  <button class="btn close-modal-button" onclick="closeModal()">OK</button>
</div>
    
    </div>
  `;

        const modal = document.getElementById("customModal");
        const message = document.getElementById("modalMessage");
        message.innerHTML = html;
        modal.classList.remove("hidden");
      }

      function resetStats() {
        if (confirm("Yakin ingin menghapus semua statistik lifetime?")) {
          localStorage.removeItem(STATS_KEY);
          alert("Statistik lifetime telah direset.");
          showStats();
        }
      }

      function resetLeaderboard() {
        if (confirm("Yakin ingin menghapus semua data leaderboard?")) {
          localStorage.removeItem(LEADERBOARD_KEY);
          alert("Leaderboard telah direset.");
          showLeaderboard();
        }
      }

      function disablePuzzleInteraction() {
        const pieces = document.querySelectorAll(".puzzle-piece");
        pieces.forEach((piece) => {
          piece.setAttribute("draggable", "false");
          piece.style.cursor = "default";
          piece.removeEventListener("click", rotatePiece);
          piece.removeEventListener("dragstart", dragStart);
          piece.removeEventListener("dragover", dragOver);
          piece.removeEventListener("drop", dropPiece);
        });
      }

      function toggleControls(isPlaying) {
        document.getElementById("preGameControls").style.display = isPlaying ? "none" : "block";
        document.getElementById("inGameControls").style.display = isPlaying ? "block" : "none";
      }

      function toggleShowButton(isPlaying) {
        document.getElementById("toggleShowButton").style.display = isPlaying ? "block" : "none";
        document.getElementById("toggleEndButton").style.display = isPlaying ? "none" : "block";
        document.getElementById("undoButtonHidden").style.display = isPlaying ? "none" : "block";
      }

      function toggleShowRotate(isRotationMode) {
        document.getElementById("toggleRotateButton").style.display = isRotationMode ? "block" : "none";
      }

      updateProgress();
      // startGame();
    </script>
  </body>
</html>
